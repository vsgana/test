name: Deploy EC2 with Terraform

on:
  push:
    branches: [main]
    tags:
      - deploy-dev
      - deploy-prod
  workflow_dispatch:
    inputs:
      stage:
        description: "dev or prod"
        required: true
        default: "dev"

jobs:
  deploy:
    runs-on: ubuntu-latest
    outputs:
      writer_ip: ${{ steps.get_ips.outputs.writer_ip }}
      reader_ip: ${{ steps.get_ips.outputs.reader_ip }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3

      - name: ğŸ· Set STAGE variable
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "STAGE=${{ github.event.inputs.stage }}" >> $GITHUB_ENV
          elif [[ "${{ github.ref }}" == "refs/tags/deploy-prod" ]]; then
            echo "STAGE=prod" >> $GITHUB_ENV
          else
            echo "STAGE=dev" >> $GITHUB_ENV
          fi

      - name: ğŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-south-1

      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v2

      - name: âš™ï¸ Terraform Init
        run: terraform init

      - name: ğŸš€ Terraform Apply
        run: terraform apply -auto-approve -var-file="${STAGE}.tfvars"

      - name: ğŸ“¤ Get Terraform Outputs (Public IPs)
        id: get_ips
        run: |
          echo "writer_ip=$(terraform output -raw writer_public_ip)" >> $GITHUB_OUTPUT
          echo "reader_ip=$(terraform output -raw reader_public_ip)" >> $GITHUB_OUTPUT
          echo "Writer IP: $(terraform output -raw writer_public_ip)"
          echo "Reader IP: $(terraform output -raw reader_public_ip)"

  health-check:
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: ğŸ” Health Check - Writer EC2 (Port 80)
        run: |
          WRITER_IP=${{ needs.deploy.outputs.writer_ip }}
          echo "Checking if port 80 is reachable on $WRITER_IP..."
          for i in {1..10}; do
            STATUS=$(curl -s --max-time 5 -o /dev/null -w "%{http_code}" http://$WRITER_IP)
            if [ "$STATUS" -eq 200 ]; then
              echo "âœ… App is healthy and reachable (HTTP 200)"
              exit 0
            else
              echo "â³ Attempt $i: Not ready yet (status: $STATUS). Retrying in 5s..."
              sleep 5
            fi
          done
          echo "âŒ App is not reachable on port 80 after multiple attempts"
          exit 1

  destroy:
    runs-on: ubuntu-latest
    needs: health-check
    if: always()  # Optional: change to `if: success()` if you only want to destroy on success
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3

      - name: ğŸ· Set STAGE variable (again)
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "STAGE=${{ github.event.inputs.stage }}" >> $GITHUB_ENV
          elif [[ "${{ github.ref }}" == "refs/tags/deploy-prod" ]]; then
            echo "STAGE=prod" >> $GITHUB_ENV
          else
            echo "STAGE=dev" >> $GITHUB_ENV
          fi

      - name: ğŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-south-1

      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v2

      - name: âš™ï¸ Terraform Init
        run: terraform init

      - name: ğŸ§¹ Terraform Destroy (Post Verification)
        run: terraform destroy -auto-approve -var-file="${STAGE}.tfvars"
